<app-unauthorized-page (isAuthorized)="isAuthorizedUser($event)" *ngIf="!isAuthorized"></app-unauthorized-page>

<div [className]="sidebarCheck ? 'half-open-breadcrum breadcrumb-box' : 'full-open-breadcrum breadcrumb-box' " #scrollToTop [hidden]="!isAuthorized">
  <ol class="breadcrumb breadcrumb-arrow ">
    <li><a class="icon ion-ios-home" routerLink="/iol"> Dashboard </a> </li>
    <!-- <li><a> User & Admin</a></li>
    <li><a routerLink="/iol/admin/permissions">Role & Access</a></li> -->
    <!-- <li><a (click)="pageReload()"> User & Admin</a></li> -->
    <li><a (click)="pageReload()">Role & Access</a></li>
  </ol>
</div>


<div [className]="sidebarCheck ? 'half-open-sidebar page-content  container-fluid' : 'full-open-sidebar page-content  container-fluid' "  style="padding-bottom:200px" [hidden]="!isAuthorized">
  <div class="row card-group-row">
    <div class="col-lg-4  card-group-row__col ">
      <div class="panel panel-default round shadow">
        <div class="panel-body padding-15">
          <div class="col-lg-6  col-md-6 col-sm-6">
            <div class="form-group margin-bottom-10">
              <button class="btn btn-success btn-block bg-theme btn-round" style="padding: 6px 13px !important;" *ngIf="loggedInUser.read_only != true"
                (click)="addNewPermission()" data-toggle="modal" data-target="#add-asset"> <i class="ri-add-circle-fill"
                  style="margin-right: 5px;"></i>Assign New Group
              </button>
            </div>
            <div class="modal fade" id="add-asset" role="dialog" style="display: none;">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">×</button>
                    <h4 class="modal-title">Assign Group</h4>
                  </div>
                  <div class="modal-body">
                    <form [formGroup]="permissionForm">
                      <div class="row">
                        <div class="col-lg-6">
                          <div class="col-lg-12">
                            <div class="form-group margin-bottom-10">
                              <label>Add Email<span class="text-danger2">*</span></label>
                              <p-multiSelect [options]="emailList" name="selectedEmails" formControlName="email"
                                [(ngModel)]="selectedEmails" optionLabel="name" styleClass="prime-dropdown"
                                filter="true" filterPlaceHolder="Search" defaultLabel="Select Emails">
                              </p-multiSelect>
                              <span class="error-message"
                                *ngIf="permissionForm.get('email').getError('required') && submitted">
                                Please select email address
                              </span>
                            </div>
                          </div>
                          <div class="col-lg-12">
                            <div class="form-group margin-bottom-10 margin-top-10">
                              <label>Select Group<span class="text-danger2">*</span></label>
                              <p-dropdown [options]="userGroup" formControlName="group_id" name="selectedGroup"
                                (onChange)="changeGroup(selectedGroup)" [(ngModel)]="selectedGroup"
                                styleClass="prime-dropdown" placeholder="Select Group">
                              </p-dropdown>
                              <span class="error-message"
                                *ngIf="permissionForm.get('group_id').getError('required') && submitted">
                                Please select group
                              </span>
                            </div>
                          </div>
                        </div>
                        <div class="col-lg-6" id="abc">
                          <div class="form-group margin-bottom-10 shadow"
                            style="border: 1px solid rgb(238, 238, 238);border-radius: 5px;background-color: rgb(248, 248, 248);min-height: 140px;max-height: 140px;overflow-y: scroll;">
                            <div style="padding: 10px;" *ngIf="selectedDesc">
                              <h5><b>{{selectedDesc?.name}}</b></h5>
                              <p>
                                Super Admin has access to following feature.
                              </p>
                              <p>{{selectedDesc?.description}}</p>
                            </div>
                            <div style="padding: 10px;" *ngIf="!selectedDesc">
                              <p>Select group from options</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </form>

                    <hr>
                    <div class="form-group margin-bottom-10 text-center">
                      <!-- <i class="ri-arrow-go-back-line"></i> -->
                      <button class="btn btn-default btn-round margin-right-10" #closeForm data-dismiss="modal">
                        Close</button>
                      <!-- <i class="ri-check-fill"></i>  -->
                      <button type="submit" class="btn btn-success btn-round" (click)="onSubmit(permissionForm.value)">
                        Save</button>

                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6 col-md-6 col-sm-6">
            <div class="form-group margin-bottom-10">
              <a href="" *ngIf="loggedInUser.read_only != true" class="btn btn-success btn-block bg-theme btn-round"
                (click)="addNewGroup()" data-toggle="modal" data-target="#add-group"> <i class="ri-add-circle-fill"
                  style="margin-right: 5px;"></i>Add New Group</a>
            </div>
            <div class="modal fade" id="add-group" role="dialog">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <form [formGroup]="groupForm">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">×</button>
                      <h4 class="modal-title">Add User Group</h4>
                    </div>
                    <div class="modal-body">
                      <div class="row">
                        <div class="col-lg-6">
                          <div class="form-group margin-bottom-10">
                            <label>Group Name<span class="text-danger2">*</span></label>
                            <input type="text" class="form-control" formControlName="name" name="name"
                              placeholder="Group Name">
                            <span class="error-message"
                              *ngIf="groupForm.get('name').getError('required') && submittedGroup">
                              Please provide name
                            </span>
                          </div>
                        </div>
                        <div class="col-lg-6">
                          <div class="form-group margin-bottom-10">
                            <label>Group Description<span class="text-danger2">*</span></label>
                            <input type="text" class="form-control" formControlName="description" value="description"
                              placeholder="....">
                            <span class="error-message"
                              *ngIf="groupForm.get('description').getError('required') && submittedGroup">
                              Please provide description
                            </span>
                          </div>
                        </div>

                        <div class="col-lg-12">
                          <div class="form-group margin-bottom-10 margin-top-10">
                            <label>Choose menu for Group<span class="text-danger2">*</span></label>
                            <dual-list [sort]="keepSorted" [source]="stations" [key]="key" [display]="display"
                              [filter]="filter" [(destination)]="confirmed" height="265px" [disabled]="disabled">
                            </dual-list>
                            <span class="error-message" *ngIf="confirmed?.length === 0 && submittedGroup">
                              Please select menu
                            </span>
                          </div>
                        </div>

                      </div>
                      <hr>
                      <div class="form-group margin-bottom-10 text-center">
                        <button #closeFormGroup class="btn btn-default btn-round margin-right-10" data-dismiss="modal">
                          Close</button>
                        <!-- <i class="ri-check-fill"></i> -->
                        <button (click)="onSubmitGroup(groupForm.value)" class="btn btn-success btn-round "
                          [disabled]="!groupForm.valid"> Save</button>
                        <!-- btnloading -->


                        <!-- <i class="ri-arrow-go-back-line"></i> -->

                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="modal fade" id="view_roleaccess" role="dialog">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <form>
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">×</button>
                      <h4 class="modal-title">Group Details</h4>
                    </div>
                    <div class="modal-body">
                      <div class="row">
                        <div class="col-lg-6">
                          <div class="form-group margin-bottom-10">
                            <label>Group Name<span class="text-danger2">*</span></label>
                            <span>{{selectedGroup?.name}}</span>
                            <!-- <span>{{roleaccessedit?.name}}</span> -->
                          </div>
                        </div>
                        <div class="col-lg-6">
                          <div class="form-group margin-bottom-10">
                            <label>Group Description<span class="text-danger2">*</span></label>
                            <span>{{selectedGroup?.description}}</span>
                            <!-- <span>{{roleaccessedit?.description}}</span> -->
                          </div>
                        </div>

                        <div class="col-lg-12">
                          <div class="form-group margin-bottom-10 margin-top-10">
                            <label>Associated Users:</label>
                            <span *ngFor="let email of selectedGroup?.accociated_email; let i = index"> {{email}} {{i
                              === selectedGroup?.accociated_email.length -1 ? '' : ',&nbsp;' }}
                            </span>
                          </div>
                        </div>


                        <div class="col-lg-12" style="pointer-events: none;opacity: 0.5;background: #FFF;">
                          <div class="form-group margin-bottom-10 margin-top-10">
                            <label>Choose menu for Group:</label>
                            <dual-list [sort]="keepSorted" [source]="stations" [key]="key" [display]="display"
                              [filter]="filter" [(destination)]="confirmed" height="265px" [disabled]="disabled">
                            </dual-list>
                          </div>
                        </div>

                      </div>
                      <hr>
                      <div class="form-group margin-bottom-10 text-center">
                        <button #closeFormGroup class="btn btn-default btn-round" data-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <div class="modal fade" id="editpop3" role="dialog">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <form>
                    <div class="modal-header">
                      <button type="button" id="closeDialog" class="close" data-dismiss="modal">×</button>
                      <h4 class="modal-title">Group Details</h4>
                    </div>
                    <div class="modal-body">
                      <div class="row">
                        <div class="col-lg-6">
                          <div class="form-group margin-bottom-10">
                            <label for="name">Group Name<span class="text-danger2">*</span></label>
                            <input class="form-control" #name="ngModel"  id="name" name="name" [(ngModel)]="selectedGroup_new.name"/>
                            <span class="error-message"
                              *ngIf="!selectedGroup_new.name && submittedGroup">
                              Please provide name
                            </span>
                          </div>
                        </div>
                        <div class="col-lg-6">
                          <div class="form-group margin-bottom-10">
                            <label for="description">Group Description<span class="text-danger2">*</span></label>
                            <input class="form-control" #description="ngModel" required id="description" name="description" [(ngModel)]="selectedGroup_new.description"/>
                            <span class="error-message"
                              *ngIf="!selectedGroup_new.description && submittedGroup">
                              Please provide description
                            </span>
                          </div>

                        </div>

                        <!-- <div class="col-lg-12">
                          <div class="form-group margin-bottom-10 margin-top-10">
                            <label>Associated Users:</label>
                            <span *ngFor="let email of selectedGroup?.accociated_email; let i = index"> {{email}} {{i
                              === selectedGroup?.accociated_email.length -1 ? '' : ',&nbsp;' }}
                            </span>
                          </div>
                        </div> -->

                        <div class="col-sm-6">
                          <div class="form-group">
                            <label class="control-label">Associated Users:<span class="text-danger2">*</span></label>
                            <div class="input-group" style="width: 100%;">
                              <p-multiSelect [options]="groupDriverList" name="selectDriver"
                                 [(ngModel)]="selectedDriver" optionLabel="name"
                                styleClass="prime-dropdown" filter="true" defaultLabel="Select Associated Users">
                              </p-multiSelect>
                              <span class="error-message"
                                *ngIf="selectedDriver.length === 0 && submittedGroup">
                                Please select atleast one user
                              </span>
                            </div>
                          </div>
                        </div>


                        <div class="col-lg-12" style="pointer-events: none;opacity: 0.5;background: #FFF;">
                          <div class="form-group margin-bottom-10 margin-top-10">
                            <label>Choose menu for Group:</label>
                            <dual-list [sort]="keepSorted" [source]="stations" [key]="key" [display]="display"
                              [filter]="filter" [(destination)]="confirmed" height="265px" [disabled]="disabled">
                            </dual-list>
                          </div>
                        </div>

                      </div>
                      <hr>
                      <div class="form-group margin-bottom-10 text-center">
                        <button #closeFormGroup class="btn btn-default btn-round" data-dismiss="modal">Close</button>
                        <button #closeFormGroup (click)="UpdateRoleaccessGroup(selectedGroup_new.id)" class="btn btn-success btn-round btn-block1">Update</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>



          <div class="col-lg-12 col-md-12 col-sm-12">
          <form [formGroup]="searchForm" (ngSubmit)="onSearch(searchForm.value)">
            <div class="form-group margin-bottom-10">
              <fieldset class="form-fieldset">
                <legend>Search</legend>

                <div class="form-group margin-bottom-10">
                  <div class="input-search">
                    <i class="input-search-icon ri-search-line"></i>
                    <input type="text" class="form-control" formControlName="search" name="" placeholder="Search...">
                    <button type="button" class="input-search-close icon " data-toggle="popover" data-original-title=""
                      data-trigger="hover" data-container="body" data-placement="top" data-html="true" id="help2"
                      pTooltip="Search by Group" tooltipPosition="top">
                      <i class="ri-question-line"></i>
                    </button>
                    <div id="popover-content-help2" class="hide">
                      Some help information goes here
                    </div>

                  </div>
                </div>

                <div class="form-group margin-bottom-0 text-center">
                  <button (click)="onSearch($event)" href="" type="submit" class="btn btn-success btn-round btn-block1">
                    <i class=" ri-search-line "></i>
                    Search</button>
                  <button (click)="onClearSearch()" href=" " class="btn btn-default btn-round "> <i
                      class="ri-refresh-line "></i>
                    Clear
                  </button>
                </div>
              </fieldset>
            </div>
          </form>
        </div>
        <div class="col-lg-12 col-md-12 col-sm-12">
          <div class="form-group margin-bottom-0">
            <label class="font-size-14 font-weight-600 ">Export:</label>
            <div class="btn-group btn-group-justified">
              <div class="btn-group" role="group">
                <a [href]="downloadableLink">
                  <button type="button" class="btn btn-outline btn-default">
                    <img src="../../../assets/images/icon-xls.png" height="50">
                    <div class="font-size-12">
                      <a [href]="downloadableLink" class="enabled">
                        Download XLS </a>
                    </div>
                  </button>
                </a>
              </div>
              <div class="btn-group" role="group">
                <a [href]="downloadableLink1">
                  <button type="button" class="btn btn-outline btn-default"> <img
                      src="../../../assets/images/icon-pdf.png" height="50">
                    <div class="font-size-12">Download PDF</div>
                  </button>
                </a>
              </div>
            </div>
          </div>
        </div>
          <hr>
          <!-- <div class="form-group margin-bottom-0">
                      <label class="font-size-14 font-weight-600 ">Export:</label>
                      <div class="btn-group btn-group-justified">
                        <div class="btn-group" role="group">
                          <a [href]="downloadableLink">
                          <button type="button" class="btn btn-outline btn-default"> <img src="../../../assets/images/icon-xls.png" height="50">
                                <div class="font-size-12">
                                  <a [href]="downloadableLink" class="enabled" >
                                  Download XLS </a>
                                </div>
                            </button>
                          </a>
                        </div>
                        <div class="btn-group" role="group">
                          <a [href]="downloadableLink1">
                            <button type="button" class="btn btn-outline btn-default"> <img src="../../../assets/images/icon-pdf.png" height="50">
                                <div class="font-size-12">Download PDF</div>
                            </button>
                          </a>
                        </div>
                    </div>
                  </div> -->
        </div>
      </div>
    </div>

    <div class="col-lg-8  card-group-row__col ">
      <div class="width-full">
        <div class="panel panel-default round shadow  ">
          <div class="panel-heading margin-bottom-0">
            <h3 class="panel-title font-weight-600 bg-theme1 white1 ">Group List</h3>
          </div>

          <div class="panel-body padding-15">
          <p-progressBar *ngIf="showIndeterminateProgress" [style]="{'height': '3px'}" mode="indeterminate">
          </p-progressBar>
            <div class="table-responsive" style="border: 1px solid #ebebeb;">

              <table matSort (matSortChange)="sortRoles($event)"
                class="table margin-bottom-0 table-condensed1 table-bordered1 text-wrap theme-table1" mat-table
                [dataSource]="permissionList" mat-elevation-z8>
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Group</th>
                  <td mat-cell *matCellDef="let row">
                    {{ row.name || 'N/A' }}
                  </td>
                </ng-container>
                <ng-container matColumnDef="description">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Description
                  </th>
                  <td mat-cell *matCellDef="let row">
                    <span class="length-row">
                      {{ row.description || 'N/A' }}
                    </span>
                  </td>
                </ng-container>
                <ng-container matColumnDef="users">
                  <th mat-header-cell *matHeaderCellDef>Users</th>
                  <td mat-cell *matCellDef="let row">
                    {{ row.accociated_email.length }}
                  </td>
                </ng-container>
                <ng-container matColumnDef="action">
                  <th mat-header-cell *matHeaderCellDef>Action
                  </th>
                  <td mat-cell *matCellDef="let row">
                    <button type="button" class="btn btn-icon  btn-info btn-xs " (click)="openViewModal(row)"
                      data-target="#view_roleaccess" data-toggle="modal" pTooltip="View">
                      <i class="icon ion-eye"></i>
                    </button>

                    <button
                      *ngIf="loggedInUser.read_only != true"
                      type="button" class="btn btn-icon btn-info btn-xs" (click)="openEditModal(row)"
                      data-target="#editpop3" data-toggle="modal" pTooltip="Edit">
                      <i class="icon ion-edit"></i>
                    </button>
                  </td>
                </ng-container>


                <tr mat-header-row *matHeaderRowDef="displayedGroupColums"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedGroupColums;"></tr>
              </table>
              <div *ngIf="permissionList?.length === 0" class="no-records">No records found</div>
              <mat-paginator translate="no" [length]="permissionListLength" [hidePageSize]="true" showFirstLastButtons
                (page)="onPaginatePermission($event)" [pageSize]="10">
              </mat-paginator>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
